<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Tracker</title>

    <link rel="manifest" href="manifest.json">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #0b1d2a;
            color: #fff;
        }

        header {
            padding: 20px;
            text-align: center;
            background: #08151f;
        }

        main {
            padding: 20px;
            max-width: 800px;
            margin: auto;
        }

        .section {
            margin-bottom: 25px;
        }

        input, select, button {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }

        button {
            cursor: pointer;
            background: #1e90ff;
            border: none;
            color: #fff;
            font-weight: bold;
        }

        .project-item {
            background: #102a3a;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-controls button {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

<header>
    <h1 id="currentProjectName">Seleziona un Progetto</h1>
</header>

<main>

    <!-- CREAZIONE PROGETTO -->
    <div class="section">
        <h2>Nuovo Progetto</h2>
        <input id="projectName" placeholder="Nome progetto">
        <input id="totalHours" type="number" placeholder="Ore totali">
        <input id="startHours" type="number" placeholder="Ore di lavoro al giorno">
        <button onclick="createProject()">Crea Progetto</button>
    </div>

    <!-- SELEZIONE PROGETTO -->
    <div class="section">
        <h2>Progetti</h2>
        <select id="projectSelect" onchange="loadProject()"></select>
    </div>

    <!-- AGGIUNGI LAVORO -->
    <div class="section">
        <h2>Aggiungi Lavoro</h2>
        <input id="workHoursInput" type="number" placeholder="Ore">
        <input id="workMinutesInput" type="number" placeholder="Minuti">
        <button onclick="addWork()">Aggiungi</button>
    </div>

    <!-- INFO -->
    <div class="section">
        <p>Tempo rimanente: <span id="timeRemaining">0h 0m</span></p>
        <p>Lavoro svolto: <span id="workDone">0h 0m</span></p>
    </div>

    <!-- REGISTRO -->
    <div class="project-controls">
        <button onclick="toggleWorkLog()">ðŸ“Š Registro Lavoro</button>
    </div>

    <div class="section" id="workLog" style="display:none;">
        <div id="workLogItems"></div>
    </div>

</main>

<script>
let projects = [];
let currentProject = null;

/* ===== STORAGE ===== */
function saveProjects() {
    localStorage.setItem('projects', JSON.stringify(projects));
}

function loadProjects() {
    const data = localStorage.getItem('projects');
    if (data) projects = JSON.parse(data);
    updateProjectSelect();
}

/* ===== PROGETTI ===== */
function createProject() {
    const name = document.getElementById('projectName').value;
    const hours = parseInt(document.getElementById('totalHours').value);
    const startHours = parseInt(document.getElementById('startHours').value);

    if (!name || hours <= 0) {
        alert('Dati non validi');
        return;
    }

    const newProject = {
        name,
        timeRemaining: hours * 60,
        workDone: 0,
        hoursToStart: startHours || 0,
        lastDayCheck: new Date().toDateString(),
        createdAt: new Date().toISOString(),
        workLog: {}
    };

    projects.push(newProject);
    saveProjects();
    updateProjectSelect();
}

function updateProjectSelect() {
    const select = document.getElementById('projectSelect');
    select.innerHTML = '<option value="">-- seleziona --</option>';

    projects.forEach((p, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = p.name;
        select.appendChild(opt);
    });
}

function loadProject() {
    const index = document.getElementById('projectSelect').value;

    if (index === '') {
        currentProject = null;
        document.getElementById('currentProjectName').textContent = 'Seleziona un Progetto';
        return;
    }

    currentProject = projects[index];
    document.getElementById('currentProjectName').textContent = currentProject.name;

    updateDisplay();
    renderWorkLog();
}

/* ===== LAVORO ===== */
function addWork() {
    if (!currentProject) {
        alert('Seleziona un progetto');
        return;
    }

    const h = parseInt(document.getElementById('workHoursInput').value) || 0;
    const m = parseInt(document.getElementById('workMinutesInput').value) || 0;
    const total = h * 60 + m;

    if (total <= 0) return;

    currentProject.workDone += total;
    currentProject.timeRemaining = Math.max(0, currentProject.timeRemaining - total);

    const today = new Date().toISOString().slice(0, 10);

    if (!currentProject.workLog[today]) {
        currentProject.workLog[today] = { entries: [], total: 0 };
    }

    currentProject.workLog[today].entries.push(total);
    currentProject.workLog[today].total += total;

    saveProjects();
    updateDisplay();
    renderWorkLog();

    document.getElementById('workHoursInput').value = '';
    document.getElementById('workMinutesInput').value = '';
}

/* ===== DISPLAY ===== */
function updateDisplay() {
    if (!currentProject) return;

    document.getElementById('timeRemaining').textContent =
        formatMinutes(currentProject.timeRemaining);

    document.getElementById('workDone').textContent =
        formatMinutes(currentProject.workDone);
}

/* ===== REGISTRO ===== */
function toggleWorkLog() {
    const el = document.getElementById('workLog');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function renderWorkLog() {
    const container = document.getElementById('workLogItems');
    container.innerHTML = '';

    if (!currentProject || !Object.keys(currentProject.workLog).length) {
        container.innerHTML = '<p>Nessun lavoro registrato</p>';
        return;
    }

    Object.keys(currentProject.workLog).sort().reverse().forEach(day => {
        const d = currentProject.workLog[day];
        const div = document.createElement('div');
        div.className = 'project-item';
        div.style.flexDirection = 'column';
        div.style.alignItems = 'flex-start';

        div.innerHTML = `
            <strong>${formatDate(day)}</strong>
            <span>Lavori: ${d.entries.map(formatMinutes).join(', ')}</span>
            <strong>Totale: ${formatMinutes(d.total)}</strong>
        `;

        container.appendChild(div);
    });
}

/* ===== UTILS ===== */
function formatMinutes(min) {
    return `${Math.floor(min / 60)}h ${min % 60}m`;
}

function formatDate(d) {
    return new Date(d).toLocaleDateString('it-IT');
}

/* ===== START ===== */
loadProjects();
</script>

</body>
</html>
