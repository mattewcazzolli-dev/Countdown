<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Work Tracker</title>

<link rel="manifest" href="manifest.json">

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0b1d2a;
    color: #fff;
}

header {
    padding: 16px;
    text-align: center;
    background: #08151f;
}

main {
    padding: 16px;
    max-width: 600px;
    margin: auto;
}

.section {
    margin-bottom: 24px;
}

input, select, button {
    width: 100%;
    padding: 12px;
    margin-top: 8px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
}

button {
    background: #1e90ff;
    color: #fff;
    font-weight: bold;
}

button.danger {
    background: #c0392b;
}

.project-row {
    background: #102a3a;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.small {
    font-size: 14px;
    opacity: 0.8;
}
</style>
</head>

<body>

<header>
    <h1 id="currentProjectName">Nessun progetto selezionato</h1>
</header>

<main>

<!-- NUOVO PROGETTO -->
<div class="section">
    <h2>Nuovo progetto</h2>
    <input id="projectName" placeholder="Nome progetto">
    <input id="totalHours" type="number" placeholder="Ore totali">
    <button onclick="createProject()">Crea progetto</button>
</div>

<!-- LISTA PROGETTI -->
<div class="section">
    <h2>Progetti</h2>
    <div id="projectList"></div>
</div>

<!-- AGGIUNGI LAVORO -->
<div class="section">
    <h2>Aggiungi lavoro</h2>
    <input id="workHours" type="number" placeholder="Ore">
    <input id="workMinutes" type="number" placeholder="Minuti">
    <button onclick="addWork()">Aggiungi lavoro</button>
</div>

<!-- STATO -->
<div class="section">
    <p>‚è≥ Tempo rimanente: <strong id="timeRemaining">0h 0m</strong></p>
    <p>‚úÖ Lavoro svolto: <strong id="workDone">0h 0m</strong></p>
</div>

<!-- REGISTRO -->
<div class="section">
    <button onclick="toggleWorkLog()">üìä Registro lavoro</button>
    <div id="workLog" style="display:none; margin-top:10px;"></div>
</div>

</main>

<script>
let projects = [];
let currentProjectIndex = null;

/* ===== STORAGE ===== */
function save() {
    localStorage.setItem('projects', JSON.stringify(projects));
}

function load() {
    const data = localStorage.getItem('projects');
    if (data) projects = JSON.parse(data);
    renderProjects();
}

/* ===== PROGETTI ===== */
function createProject() {
    const name = projectName.value.trim();
    const hours = parseInt(totalHours.value);

    if (!name || hours <= 0) {
        alert('Dati non validi');
        return;
    }

    projects.push({
        name,
        timeRemaining: hours * 60,
        workDone: 0,
        workLog: {}
    });

    save();
    renderProjects();
    projectName.value = '';
    totalHours.value = '';
}

function renderProjects() {
    const list = document.getElementById('projectList');
    list.innerHTML = '';

    projects.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'project-row';
        div.innerHTML = `
            <span onclick="selectProject(${i})">${p.name}</span>
            <button class="danger" onclick="deleteProject(${i})">‚úï</button>
        `;
        list.appendChild(div);
    });
}

function selectProject(i) {
    currentProjectIndex = i;
    document.getElementById('currentProjectName').textContent = projects[i].name;
    updateDisplay();
    renderWorkLog();
}

function deleteProject(i) {
    if (!confirm('Cancellare il progetto?')) return;
    projects.splice(i, 1);
    currentProjectIndex = null;
    save();
    renderProjects();
    document.getElementById('currentProjectName').textContent = 'Nessun progetto selezionato';
    updateDisplay();
    document.getElementById('workLog').innerHTML = '';
}

/* ===== LAVORO ===== */
function addWork() {
    if (currentProjectIndex === null) {
        alert('Seleziona un progetto');
        return;
    }

    const h = parseInt(workHours.value) || 0;
    const m = parseInt(workMinutes.value) || 0;
    const total = h * 60 + m;

    if (total <= 0) return;

    const p = projects[currentProjectIndex];

    p.workDone += total;
    p.timeRemaining = Math.max(0, p.timeRemaining - total);

    const today = new Date().toISOString().slice(0,10);
    if (!p.workLog[today]) p.workLog[today] = [];
    p.workLog[today].push(total);

    save();
    updateDisplay();
    renderWorkLog();

    workHours.value = '';
    workMinutes.value = '';
}

/* ===== DISPLAY ===== */
function updateDisplay() {
    if (currentProjectIndex === null) {
        timeRemaining.textContent = '0h 0m';
        workDone.textContent = '0h 0m';
        return;
    }

    const p = projects[currentProjectIndex];
    timeRemaining.textContent = format(p.timeRemaining);
    workDone.textContent = format(p.workDone);
}

/* ===== REGISTRO ===== */
function toggleWorkLog() {
    const el = document.getElementById('workLog');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function renderWorkLog() {
    const el = document.getElementById('workLog');
    el.innerHTML = '';

    if (currentProjectIndex === null) return;

    const log = projects[currentProjectIndex].workLog;
    const days = Object.keys(log).sort().reverse();

    if (!days.length) {
        el.innerHTML = '<p class="small">Nessun lavoro registrato</p>';
        return;
    }

    days.forEach(d => {
        const total = log[d].reduce((a,b)=>a+b,0);
        const div = document.createElement('div');
        div.className = 'project-row';
        div.style.flexDirection = 'column';
        div.innerHTML = `
            <strong>${new Date(d).toLocaleDateString('it-IT')}</strong>
            <span class="small">Lavori: ${log[d].map(format).join(', ')}</span>
            <strong>Totale: ${format(total)}</strong>
        `;
        el.appendChild(div);
    });
}

/* ===== UTILS ===== */
function format(min) {
    return `${Math.floor(min/60)}h ${min%60}m`;
}

/* ===== START ===== */
load();
</script>

</body>
</html>
