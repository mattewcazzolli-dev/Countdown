<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Work Tracker</title>

<link rel="manifest" href="manifest.json">

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0b1d2a;
    color: #fff;
}

header {
    padding: 16px;
    text-align: center;
    background: #08151f;
}

main {
    padding: 16px;
    max-width: 600px;
    margin: auto;
}

.section {
    margin-bottom: 24px;
}

input, select, button {
    width: 100%;
    padding: 12px;
    margin-top: 8px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
}

button {
    background: #1e90ff;
    color: #fff;
    font-weight: bold;
}

button.danger {
    background: #c0392b;
}

.project-row,
.project-item {
    background: #102a3a;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.project-controls button {
    margin-bottom: 10px;
}

.small {
    font-size: 14px;
    opacity: 0.8;
}
</style>
</head>

<body>

<header>
    <h1 id="currentProjectName">Nessun progetto selezionato</h1>
</header>

<main>

<!-- NUOVO PROGETTO -->
<div class="section">
    <h2>Nuovo progetto</h2>
    <input id="projectName" placeholder="Nome progetto">
    <input id="totalHours" type="number" placeholder="Ore totali">
    <button onclick="createProject()">Crea progetto</button>
</div>

<!-- LISTA PROGETTI -->
<div class="section">
    <h2>Progetti</h2>
    <div id="projectList"></div>
</div>

<!-- AGGIUNGI LAVORO -->
<div class="section">
    <h2>Aggiungi lavoro</h2>
    <input id="workHoursInput" type="number" placeholder="Ore">
    <input id="workMinutesInput" type="number" placeholder="Minuti">
    <button onclick="addWork()">Aggiungi lavoro</button>
</div>

<!-- STATO -->
<div class="section">
    <p>‚è≥ Tempo rimanente: <strong id="timeRemaining">0h 0m</strong></p>
    <p>‚úÖ Lavoro svolto: <strong id="workDone">0h 0m</strong></p>
</div>

<!-- CONTROLLI -->
<div class="project-controls">
    <button onclick="toggleWorkLog()">üìä Registro di Lavoro</button>
</div>

<!-- REGISTRO -->
<div class="section" id="workLog" style="display:none;">
    <h2>Registro Lavoro</h2>
    <div id="workLogItems"></div>
</div>

</main>

<script>
let projects = [];
let currentProjectIndex = null;

/* ===== STORAGE ===== */
function saveProjects() {
    localStorage.setItem('projects', JSON.stringify(projects));
}

function loadProjects() {
    const data = localStorage.getItem('projects');
    if (data) projects = JSON.parse(data);
    renderProjects();
}

/* ===== PROGETTI ===== */
function createProject() {
    const name = projectName.value.trim();
    const hours = parseInt(totalHours.value);

    if (!name || hours <= 0) {
        alert('Dati non validi');
        return;
    }

    const newProject = {
        name,
        timeRemaining: hours * 60,
        workDone: 0,
        workLog: {}
    };

    projects.push(newProject);
    saveProjects();
    renderProjects();

    projectName.value = '';
    totalHours.value = '';
}

function renderProjects() {
    const list = document.getElementById('projectList');
    list.innerHTML = '';

    projects.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'project-row';
        div.innerHTML = `
            <span onclick="selectProject(${i})">${p.name}</span>
            <button class="danger" onclick="deleteProject(${i})">‚úï</button>
        `;
        list.appendChild(div);
    });
}

function selectProject(i) {
    currentProjectIndex = i;
    document.getElementById('currentProjectName').textContent = projects[i].name;
    updateDisplay();
    renderWorkLog();
}

function deleteProject(i) {
    if (!confirm('Cancellare il progetto?')) return;

    projects.splice(i, 1);
    currentProjectIndex = null;
    saveProjects();
    renderProjects();

    document.getElementById('currentProjectName').textContent = 'Nessun progetto selezionato';
    updateDisplay();
    document.getElementById('workLogItems').innerHTML = '';
}

/* ===== LAVORO ===== */
function addWork() {
    if (currentProjectIndex === null) {
        alert('Seleziona un progetto');
        return;
    }

    const h = parseInt(workHoursInput.value) || 0;
    const m = parseInt(workMinutesInput.value) || 0;
    const totalMinutes = h * 60 + m;

    if (totalMinutes <= 0) return;

    const currentProject = projects[currentProjectIndex];

    currentProject.workDone += totalMinutes;
    currentProject.timeRemaining = Math.max(
        0,
        currentProject.timeRemaining - totalMinutes
    );

    const today = new Date().toISOString().slice(0, 10);

    if (!currentProject.workLog[today]) {
        currentProject.workLog[today] = {
            entries: [],
            total: 0
        };
    }

    currentProject.workLog[today].entries.push(totalMinutes);
    currentProject.workLog[today].total += totalMinutes;

    saveProjects();
    updateDisplay();
    renderWorkLog();

    workHoursInput.value = '';
    workMinutesInput.value = '';
}

/* ===== DISPLAY ===== */
function updateDisplay() {
    if (currentProjectIndex === null) {
        timeRemaining.textContent = '0h 0m';
        workDone.textContent = '0h 0m';
        return;
    }

    const p = projects[currentProjectIndex];
    timeRemaining.textContent = formatMinutes(p.timeRemaining);
    workDone.textContent = formatMinutes(p.workDone);
}

/* ===== REGISTRO ===== */
function toggleWorkLog() {
    const el = document.getElementById('workLog');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function renderWorkLog() {
    const container = document.getElementById('workLogItems');
    container.innerHTML = '';

    if (currentProjectIndex === null) {
        container.innerHTML = '<p class="small">Nessun lavoro registrato</p>';
        return;
    }

    const log = projects[currentProjectIndex].workLog;
    const days = Object.keys(log).sort().reverse();

    if (days.length === 0) {
        container.innerHTML = '<p class="small">Nessun lavoro registrato</p>';
        return;
    }

    days.forEach(day => {
        const data = log[day];

        const div = document.createElement('div');
        div.className = 'project-item';
        div.style.flexDirection = 'column';
        div.style.alignItems = 'flex-start';

        div.innerHTML = `
            <strong>${new Date(day).toLocaleDateString('it-IT')}</strong>
            <span class="small">
                Lavori: ${data.entries.map(formatMinutes).join(', ')}
            </span>
            <strong>Totale: ${formatMinutes(data.total)}</strong>
        `;

        container.appendChild(div);
    });
}

/* ===== UTILS ===== */
function formatMinutes(min) {
    return `${Math.floor(min / 60)}h ${min % 60}m`;
}

/* ===== START ===== */
loadProjects();
</script>

</body>
</html>
