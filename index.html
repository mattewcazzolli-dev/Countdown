<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Work Tracker</title>

<link rel="manifest" href="manifest.json">

<style>
body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0b1d2a;
    color: #fff;
}

/* ===== HEADER STATS ===== */
header {
    padding: 20px;
    background: linear-gradient(180deg, #08151f, #0b1d2a);
    text-align: center;
}

.stats {
    display: flex;
    justify-content: space-between;
    gap: 10px;
}

.stat-box {
    flex: 1;
    background: #102a3a;
    padding: 16px;
    border-radius: 14px;
}

.stat-box h3 {
    margin: 0;
    font-size: 14px;
    opacity: 0.7;
}

.stat-box p {
    margin: 6px 0 0;
    font-size: 22px;
    font-weight: bold;
}

/* ===== MAIN ===== */
main {
    padding: 16px;
    max-width: 600px;
    margin: auto;
}

.section {
    margin-bottom: 26px;
}

input, select, button {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    font-size: 16px;
    border-radius: 12px;
    border: none;
}

select {
    background: #102a3a;
    color: #fff;
}

input {
    background: #102a3a;
    color: #fff;
}

button {
    background: #1e90ff;
    color: #fff;
    font-weight: bold;
}

button.secondary {
    background: #102a3a;
}

button.danger {
    background: #c0392b;
}

/* ===== REGISTRO ===== */
.project-item {
    background: #102a3a;
    padding: 14px;
    border-radius: 12px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
}

.small {
    font-size: 14px;
    opacity: 0.8;
}

.inline {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.inline input {
    flex: 1;
}
.inline button {
    flex: 0 0 auto;
}
</style>
</head>

<body>

<header>
    <div class="stats">
        <div class="stat-box">
            <h3>‚è≥ Tempo rimanente</h3>
            <p id="timeRemaining">0h 0m</p>
        </div>
        <div class="stat-box">
            <h3>‚úÖ Lavoro svolto</h3>
            <p id="workDone">0h 0m</p>
        </div>
    </div>
</header>

<main>

<!-- SELEZIONE PROGETTO -->
<div class="section">
    <select id="projectSelect" onchange="selectProjectFromDropdown()">
        <option value="">Seleziona progetto</option>
    </select>
</div>

<!-- AGGIUNGI LAVORO -->
<div class="section">
    <h2>Aggiungi lavoro</h2>
    <input id="workHoursInput" type="number" placeholder="Ore">
    <input id="workMinutesInput" type="number" placeholder="Minuti">
    <button onclick="addWork()">Aggiungi</button>
</div>

<!-- REGISTRO -->
<div class="section">
    <button class="secondary" onclick="toggleWorkLog()">üìä Registro di lavoro</button>
    <div id="workLog" style="display:none; margin-top:12px;">
        <div id="workLogItems"></div>
    </div>
</div>

<!-- NUOVO/GESTIONE PROGETTO (COLLAPSIBILE, IN FONDO) -->
<div class="section">
    <button class="secondary" onclick="toggleNewProject()">‚öôÔ∏è Gestione progetto</button>
    <div id="newProjectSection" style="display:none; margin-top:12px;">

        <!-- CREA NUOVO PROGETTO -->
        <h3>Crea nuovo progetto</h3>
        <input id="projectName" placeholder="Nome progetto">
        <input id="totalHours" type="number" placeholder="Ore totali">
        <button onclick="createProject()">Crea nuovo progetto</button>

        <hr style="margin:20px 0; border-color:#1e3a50;">

        <!-- CANCELLA PROGETTO -->
        <h3>Elimina progetto selezionato</h3>
        <button class="danger" onclick="deleteCurrentProject()">Elimina progetto</button>

        <hr style="margin:20px 0; border-color:#1e3a50;">

        <!-- MODIFICA GIORNATE -->
        <h3>Modifica giornate registrate</h3>
        <div id="editDaysContainer"></div>

    </div>
</div>

</main>

<script>
let projects = [];
let currentProjectIndex = null;

/* ===== STORAGE ===== */
function saveProjects() {
    localStorage.setItem('projects', JSON.stringify(projects));
}

function loadProjects() {
    const data = localStorage.getItem('projects');
    if (data) projects = JSON.parse(data);
    renderProjectDropdown();
}

/* ===== PROGETTI ===== */
function createProject() {
    const name = projectName.value.trim();
    const hours = parseInt(totalHours.value);

    if (!name || hours <= 0) {
        alert('Dati non validi');
        return;
    }

    projects.push({
        name,
        timeRemaining: hours * 60,
        workDone: 0,
        workLog: {}
    });

    saveProjects();
    renderProjectDropdown();

    projectName.value = '';
    totalHours.value = '';
    toggleNewProject();
}

function renderProjectDropdown() {
    const select = document.getElementById('projectSelect');
    select.innerHTML = '<option value="">Seleziona progetto</option>';

    projects.forEach((p, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = p.name;
        select.appendChild(opt);
    });
}

function selectProjectFromDropdown() {
    const i = projectSelect.value;
    if (i === '') {
        currentProjectIndex = null;
        updateDisplay();
        document.getElementById('workLogItems').innerHTML = '';
        renderEditDays();
        return;
    }
    currentProjectIndex = parseInt(i);
    updateDisplay();
    renderWorkLog();
    renderEditDays();
}

function deleteCurrentProject() {
    if (currentProjectIndex === null) return;
    if (!confirm('Cancellare il progetto?')) return;

    projects.splice(currentProjectIndex, 1);
    currentProjectIndex = null;
    saveProjects();
    renderProjectDropdown();
    updateDisplay();
    document.getElementById('workLogItems').innerHTML = '';
    renderEditDays();
}

/* ===== LAVORO ===== */
function addWork() {
    if (currentProjectIndex === null) {
        alert('Seleziona un progetto');
        return;
    }

    const h = parseInt(workHoursInput.value) || 0;
    const m = parseInt(workMinutesInput.value) || 0;
    const total = h * 60 + m;
    if (total <= 0) return;

    const p = projects[currentProjectIndex];

    p.workDone += total;
    p.timeRemaining = Math.max(0, p.timeRemaining - total);

    const today = new Date().toISOString().slice(0, 10);
    if (!p.workLog[today]) {
        p.workLog[today] = { entries: [], total: 0 };
    }
    p.workLog[today].entries.push(total);
    p.workLog[today].total += total;

    saveProjects();
    updateDisplay();
    renderWorkLog();
    renderEditDays();

    workHoursInput.value = '';
    workMinutesInput.value = '';
}

/* ===== DISPLAY ===== */
function updateDisplay() {
    if (currentProjectIndex === null) {
        timeRemaining.textContent = '0h 0m';
        workDone.textContent = '0h 0m';
        return;
    }

    const p = projects[currentProjectIndex];
    timeRemaining.textContent = formatMinutes(p.timeRemaining);
    workDone.textContent = formatMinutes(p.workDone);
}

/* ===== REGISTRO ===== */
function toggleWorkLog() {
    const el = document.getElementById('workLog');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function renderWorkLog() {
    const container = document.getElementById('workLogItems');
    container.innerHTML = '';

    if (currentProjectIndex === null) return;

    const log = projects[currentProjectIndex].workLog;
    const days = Object.keys(log).sort().reverse();

    if (!days.length) {
        container.innerHTML = '<p class="small">Nessun lavoro registrato</p>';
        return;
    }

    days.forEach(day => {
        const d = log[day];
        const div = document.createElement('div');
        div.className = 'project-item';

        div.innerHTML = `
            <strong>${new Date(day).toLocaleDateString('it-IT')}</strong>
            <span class="small">Lavori: ${d.entries.map(formatMinutes).join(', ')}</span>
            <strong>Totale: ${formatMinutes(d.total)}</strong>
        `;

        container.appendChild(div);
    });
}

/* ===== MODIFICA GIORNATE ===== */
function renderEditDays() {
    const container = document.getElementById('editDaysContainer');
    container.innerHTML = '';

    if (currentProjectIndex === null) return;

    const log = projects[currentProjectIndex].workLog;
    const days = Object.keys(log).sort().reverse();

    if (!days.length) {
        container.innerHTML = '<p class="small">Nessun lavoro registrato</p>';
        return;
    }

    days.forEach(day => {
        const d = log[day];
        const div = document.createElement('div');
        div.className = 'project-item';

        const inputDate = document.createElement('input');
        inputDate.type = 'date';
        inputDate.value = day;

        const inputTotal = document.createElement('input');
        inputTotal.type = 'number';
        inputTotal.value = d.total;
        inputTotal.placeholder = 'Minuti totali';

        const btnUpdate = document.createElement('button');
        btnUpdate.textContent = 'Aggiorna';
        btnUpdate.onclick = () => {
            const newDate = inputDate.value;
            const newTotal = parseInt(inputTotal.value) || 0;

            // aggiorna workDone
            const p = projects[currentProjectIndex];
            p.workDone = p.workDone - d.total + newTotal;

            // aggiorna timeRemaining
            p.timeRemaining += d.total - newTotal;

            // aggiorna workLog
            delete p.workLog[day];
            p.workLog[newDate] = { entries: [newTotal], total: newTotal };

            saveProjects();
            updateDisplay();
            renderWorkLog();
            renderEditDays();
        };

        div.appendChild(inputDate);
        div.appendChild(inputTotal);
        div.appendChild(btnUpdate);
        container.appendChild(div);
    });
}

/* ===== COLLAPSE ===== */
function toggleNewProject() {
    const el = document.getElementById('newProjectSection');
    el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

/* ===== UTILS ===== */
function formatMinutes(min) {
    return `${Math.floor(min / 60)}h ${min % 60}m`;
}

/* ===== START ===== */
loadProjects();
</script>

</body>
</html>
